name: Code Quality

on:
  push:
    branches: [main, "claude/**"]
  pull_request:
    branches: [main]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run Prettier check
        run: npm run format:check
        continue-on-error: false

      - name: TypeScript type check
        run: npm run type-check
        continue-on-error: true

      - name: Build check
        run: npm run build
        env:
          NEXT_PUBLIC_BYPASS_AUTH: "true"
        continue-on-error: false

  naming-convention-check:
    name: Check for backup/duplicate files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for backup files
        run: |
          echo "Checking for backup files with patterns: *_v[0-9]*, *_backup*, *_old*, *.bak, * 2.*"

          # Find backup files (excluding node_modules, .next, .git)
          BACKUP_FILES=$(find . -type f \( \
            -name "*_v[0-9]*" -o \
            -name "*_backup*" -o \
            -name "*_old*" -o \
            -name "*.bak" -o \
            -name "* 2.*" \
          \) \
          -not -path "*/node_modules/*" \
          -not -path "*/.next/*" \
          -not -path "*/.git/*" \
          -not -path "*/playwright-report*/*" || true)

          if [ -n "$BACKUP_FILES" ]; then
            echo "❌ Found backup/duplicate files:"
            echo "$BACKUP_FILES"
            echo ""
            echo "Please remove these files. Use git for version control instead of backup files."
            exit 1
          else
            echo "✅ No backup files found"
          fi

      - name: Check for backup directories
        run: |
          echo "Checking for backup directories with ' 2' suffix..."

          # Find backup directories
          BACKUP_DIRS=$(find . -type d -name "* 2" \
          -not -path "*/node_modules/*" \
          -not -path "*/.next/*" \
          -not -path "*/.git/*" || true)

          if [ -n "$BACKUP_DIRS" ]; then
            echo "❌ Found backup directories:"
            echo "$BACKUP_DIRS"
            echo ""
            echo "Please remove these directories."
            exit 1
          else
            echo "✅ No backup directories found"
          fi

  documentation-check:
    name: Documentation structure check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify essential documentation exists
        run: |
          echo "Checking for essential documentation..."

          MISSING_DOCS=""

          # Check for essential docs
          [ ! -f "README.md" ] && MISSING_DOCS="$MISSING_DOCS README.md"
          [ ! -f "CLAUDE.md" ] && MISSING_DOCS="$MISSING_DOCS CLAUDE.md"
          [ ! -f "CONTRIBUTING.md" ] && MISSING_DOCS="$MISSING_DOCS CONTRIBUTING.md"
          [ ! -f "docs/CODING_STANDARDS.md" ] && MISSING_DOCS="$MISSING_DOCS docs/CODING_STANDARDS.md"

          if [ -n "$MISSING_DOCS" ]; then
            echo "❌ Missing essential documentation:"
            echo "$MISSING_DOCS"
            exit 1
          else
            echo "✅ All essential documentation files present"
          fi

      - name: Check for scattered documentation in root
        run: |
          echo "Checking for scattered .md files in root (excluding essential docs)..."

          # Count non-essential .md files in root
          SCATTERED_DOCS=$(find . -maxdepth 1 -name "*.md" -type f \
            ! -name "README.md" \
            ! -name "CLAUDE.md" \
            ! -name "CLAUDE.local.md" \
            ! -name "CONTRIBUTING.md" \
            ! -name "TESTING_FUNDAMENTALS.md" \
            | wc -l)

          if [ "$SCATTERED_DOCS" -gt 5 ]; then
            echo "⚠️  Warning: $SCATTERED_DOCS non-essential .md files found in root directory"
            echo "Consider organizing them into docs/ subdirectories"
            # Don't fail, just warn
          else
            echo "✅ Documentation is well organized"
          fi
