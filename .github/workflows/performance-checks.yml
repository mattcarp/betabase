name: Performance Checks

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  performance-checks:
    runs-on: ubuntu-latest
    name: Performance and Quality Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type checking
        run: npm run type-check
        continue-on-error: true
        id: type-check

      - name: ESLint checking
        run: npm run lint
        continue-on-error: true
        id: lint

      - name: Run bundle analyzer
        run: ANALYZE=true npm run build
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-dummy-key-for-ci' }}
          OPENAI_ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID || 'asst-dummy-id' }}

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-analysis
          path: .next/analyze/

      - name: Check bundle size
        run: |
          # Get the size of the main bundle
          BUNDLE_SIZE=$(du -sk .next/static | cut -f1)
          echo "Bundle size: ${BUNDLE_SIZE}KB"

          # Set a threshold (e.g., 2000KB = 2MB)
          THRESHOLD=2000

          if [ $BUNDLE_SIZE -gt $THRESHOLD ]; then
            echo "::warning::Bundle size (${BUNDLE_SIZE}KB) exceeds threshold (${THRESHOLD}KB)"
            exit 1
          fi

      - name: Run performance tests
        run: npm run test:performance
        continue-on-error: true

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const typeCheckStatus = '${{ steps.type-check.outcome }}';
            const lintStatus = '${{ steps.lint.outcome }}';

            const comment = `## üìä Performance Check Results

            | Check | Status |
            |-------|--------|
            | TypeScript | ${typeCheckStatus === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} |
            | ESLint | ${lintStatus === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Bundle Size | ‚úÖ Within limits |

            Bundle analysis artifacts are available in the workflow run.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
