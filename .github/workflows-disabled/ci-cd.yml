name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests (emergency deploy only)"
        required: false
        default: "false"

env:
  NODE_VERSION: "22"
  PRODUCTION_URL: "https://iamsiam.ai"

jobs:
  # ============================================================================
  # STAGE 1: CODE QUALITY & SECURITY
  # ============================================================================

  quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: TypeScript type check
        run: npx tsc --noEmit -p tsconfig.ci.json
        continue-on-error: true # 300+ pre-existing TS errors - log but don't block

      - name: ESLint check
        run: npm run lint
        # REMOVED: || true - fail on linting errors

      - name: Prettier formatting check
        run: npm run format:check
        # Fail build if code is not properly formatted

      - name: Security audit (high/critical only)
        run: npm audit --audit-level=high
        continue-on-error: true # Allow minor vulnerabilities, but log them

      - name: Check for exposed secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'main' }}
          head: HEAD
        continue-on-error: true # Don't block on false positives

      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            eslint-report.json
            audit-report.json
          retention-days: 7

  # ============================================================================
  # STAGE 2: BUILD APPLICATION
  # ============================================================================

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate build info
        run: node scripts/generate-build-info.js

      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_COGNITO_USER_POOL_ID: ${{ secrets.NEXT_PUBLIC_COGNITO_USER_POOL_ID }}
          NEXT_PUBLIC_COGNITO_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_COGNITO_CLIENT_ID }}
          NEXT_PUBLIC_CLOUDFRONT_URL: ${{ secrets.NEXT_PUBLIC_CLOUDFRONT_URL }}
          NEXT_PUBLIC_AWS_REGION: us-east-2
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            public/
          retention-days: 1

  # ============================================================================
  # STAGE 3: CRITICAL TESTS (P0 - MUST PASS)
  # ============================================================================

  aoma-validation:
    name: AOMA Anti-Hallucination Tests (P0 CRITICAL)
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run AOMA knowledge validation
        run: npm run test:aoma:knowledge
        continue-on-error: false # MUST PASS - prevents hallucination

      - name: Run AOMA anti-hallucination tests
        run: npm run test:aoma:hallucination
        continue-on-error: false # MUST PASS - critical for accuracy

      - name: Upload AOMA test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aoma-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 14

      - name: Create issue on AOMA test failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CRITICAL: AOMA Anti-Hallucination Tests Failed',
              body: `## AOMA Validation Failure

              The AOMA anti-hallucination tests have failed. This is a P0 CRITICAL issue.

              **What this means:**
              - AI may be providing inaccurate information
              - Knowledge base validation failed
              - **DO NOT DEPLOY** until this is resolved

              **Action Required:**
              1. Review test failures in artifacts
              2. Check knowledge base integrity
              3. Verify AI model responses
              4. Fix issues before deployment

              **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Commit:** ${{ github.sha }}
              `,
              labels: ['critical', 'P0', 'aoma', 'testing'],
              assignees: ['mattcarp']
            });

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual regression tests
        run: npx playwright test tests/visual/dark-theme-regression.spec.ts
        continue-on-error: false # Fail on visual regressions

      - name: Upload visual test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start development server
        run: |
          npm run dev &
          # Wait for server to be ready
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          NEXT_PUBLIC_BYPASS_AUTH: true

      - name: Run smoke tests
        run: npx playwright test tests/e2e/smoke/smoke.spec.ts
        env:
          NEXT_PUBLIC_BYPASS_AUTH: true
        continue-on-error: false # REMOVED: smoke tests must pass

      - name: Run critical path tests
        run: npm run test:critical
        env:
          NEXT_PUBLIC_BYPASS_AUTH: true
        continue-on-error: false

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  curate-functionality:
    name: File Upload/Curation Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run curate tab tests
        run: npx playwright test tests/curate-tab-test.spec.ts
        continue-on-error: false

      - name: Upload curate test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: curate-test-results
          path: playwright-report/
          retention-days: 7

  # ============================================================================
  # STAGE 4: DEPLOYMENT QUALITY GATE
  # ============================================================================

  pre-deployment-gate:
    name: Pre-Deployment Quality Gate
    runs-on: ubuntu-latest
    needs: [quality, build, aoma-validation, visual-regression, e2e-smoke, curate-functionality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: All quality gates passed
        run: |
          echo "=========================================="
          echo "‚úÖ PRE-DEPLOYMENT QUALITY GATE PASSED"
          echo "=========================================="
          echo ""
          echo "All critical tests have passed:"
          echo "  ‚úÖ Code Quality & Security"
          echo "  ‚úÖ Build Success"
          echo "  ‚úÖ AOMA Anti-Hallucination Tests (P0)"
          echo "  ‚úÖ Visual Regression Tests"
          echo "  ‚úÖ E2E Smoke Tests"
          echo "  ‚úÖ File Upload/Curation Tests"
          echo ""
          echo "üöÄ DEPLOYMENT AUTHORIZED"
          echo "=========================================="

  # ============================================================================
  # STAGE 5: RENDER DEPLOYMENT VALIDATION
  # ============================================================================

  validate-deployment:
    name: Validate Production Deployment
    runs-on: ubuntu-latest
    needs: pre-deployment-gate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://iamsiam.ai
    outputs:
      deployment_status: ${{ steps.health_check.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Render auto-deployment
        run: |
          echo "=========================================="
          echo "üöÄ RENDER AUTO-DEPLOYMENT"
          echo "=========================================="
          echo ""
          echo "Render automatically deploys when commits are pushed to main"
          echo "Waiting for deployment to complete..."
          echo ""

      - name: Wait for deployment to stabilize
        run: |
          echo "‚è≥ Waiting 60 seconds for deployment to stabilize..."
          sleep 60

      - name: Health check with retries
        id: health_check
        run: |
          echo "=========================================="
          echo "üîç PRODUCTION HEALTH CHECKS"
          echo "=========================================="
          echo ""

          MAX_RETRIES=20
          RETRY_DELAY=15
          SUCCESS=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."

            # Check health endpoint
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health || echo "000")
            echo "  Health endpoint: $HEALTH_STATUS"

            # Check main page
            MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }} || echo "000")
            echo "  Main page: $MAIN_STATUS"

            if [ "$HEALTH_STATUS" = "200" ] && [ "$MAIN_STATUS" = "200" ]; then
              echo ""
              echo "‚úÖ Health check passed!"
              echo "‚úÖ Main page loads successfully!"
              SUCCESS=true
              break
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "  ‚è≥ Waiting ${RETRY_DELAY}s before retry..."
              echo ""
              sleep $RETRY_DELAY
            fi
          done

          echo "=========================================="
          if [ "$SUCCESS" = true ]; then
            echo "‚úÖ DEPLOYMENT SUCCESSFUL"
            exit 0
          else
            echo "‚ùå DEPLOYMENT FAILED"
            echo "Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Create deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.health_check.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
            const state = '${{ steps.health_check.outcome }}' === 'success' ? 'success' : 'failure';
            const sha = context.sha.substring(0, 7);
            const message = context.payload.head_commit?.message || 'No commit message';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: '${{ env.PRODUCTION_URL }}',
              description: `Deployment ${status}: ${message}`.substring(0, 140),
              context: 'render/deployment'
            });

      - name: Create issue on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® PRODUCTION DEPLOYMENT FAILED',
              body: `## Deployment Health Check Failed

              The production deployment failed health checks.

              **Status:**
              - Health endpoint: Failed to respond
              - Main page: Failed to load

              **Action Required:**
              1. Check Render dashboard: https://dashboard.render.com
              2. Review deployment logs
              3. Consider rollback if site is down
              4. Investigate health check failures

              **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Commit:** ${{ github.sha }}
              **Time:** ${new Date().toISOString()}
              `,
              labels: ['deployment', 'critical', 'P0', 'production'],
              assignees: ['mattcarp']
            });

  # ============================================================================
  # STAGE 6: POST-DEPLOYMENT VALIDATION
  # ============================================================================

  post-deployment-validation:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: needs.validate-deployment.outputs.deployment_status == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Production smoke tests
        run: |
          echo "=========================================="
          echo "üî• PRODUCTION SMOKE TESTS"
          echo "=========================================="
          echo ""

          # Test main endpoints
          endpoints=(
            "${{ env.PRODUCTION_URL }}"
            "${{ env.PRODUCTION_URL }}/api/health"
            "${{ env.PRODUCTION_URL }}/chat"
          )

          for endpoint in "${endpoints[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint")
            if [ "$response" != "200" ]; then
              echo "‚ùå Failed: $endpoint returned $response"
              exit 1
            fi
            echo "‚úÖ Passed: $endpoint (HTTP $response)"
          done

      - name: Performance check
        run: |
          echo ""
          echo "=========================================="
          echo "‚ö° PERFORMANCE CHECK"
          echo "=========================================="
          echo ""

          # Measure response time
          response_time=$(curl -o /dev/null -s -w '%{time_total}' ${{ env.PRODUCTION_URL }})
          response_ms=$(echo "$response_time * 1000" | bc)

          echo "Response time: ${response_ms}ms (${response_time}s)"

          # Fail if extremely slow (>5 seconds)
          if (( $(echo "$response_time > 5" | bc -l) )); then
            echo "‚ùå ERROR: Response time exceeds 5 seconds!"
            exit 1
          fi

          # Warn if slow (>3 seconds)
          if (( $(echo "$response_time > 3" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Response time exceeds 3 seconds"
          else
            echo "‚úÖ Performance: Good"
          fi

      - name: Console error check
        run: |
          echo ""
          echo "=========================================="
          echo "üîç CONSOLE ERROR DETECTION"
          echo "=========================================="
          echo ""

          npx playwright test tests/e2e/smoke/smoke.spec.ts --grep "console errors" || true

          echo "‚úÖ Console error check complete"

      - name: Send success notification
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo ""
          echo "üåê URL: ${{ env.PRODUCTION_URL }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üïê Time: $(date)"
          echo "=========================================="

  # ============================================================================
  # STAGE 7: PR FEEDBACK
  # ============================================================================

  pr-comment:
    name: PR Test Summary
    runs-on: ubuntu-latest
    needs: [quality, build, aoma-validation, visual-regression, e2e-smoke, curate-functionality]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              quality: '${{ needs.quality.result }}',
              build: '${{ needs.build.result }}',
              aoma: '${{ needs.aoma-validation.result }}',
              visual: '${{ needs.visual-regression.result }}',
              e2e: '${{ needs.e2e-smoke.result }}',
              curate: '${{ needs.curate-functionality.result }}'
            };

            const getEmoji = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'failure') return '‚ùå';
              if (status === 'skipped') return '‚è≠Ô∏è';
              return '‚è≥';
            };

            const allPassed = Object.values(jobs).every(status =>
              status === 'success' || status === 'skipped'
            );

            const comment = `## üß™ Test Results

            ${allPassed ? '### ‚úÖ All Tests Passed!' : '### ‚ùå Some Tests Failed'}

            | Test Suite | Status |
            |------------|--------|
            | Code Quality & Security | ${getEmoji(jobs.quality)} ${jobs.quality} |
            | Build | ${getEmoji(jobs.build)} ${jobs.build} |
            | AOMA Anti-Hallucination (P0) | ${getEmoji(jobs.aoma)} ${jobs.aoma} |
            | Visual Regression | ${getEmoji(jobs.visual)} ${jobs.visual} |
            | E2E Smoke Tests | ${getEmoji(jobs.e2e)} ${jobs.e2e} |
            | File Upload/Curation | ${getEmoji(jobs.curate)} ${jobs.curate} |

            ${allPassed ?
              'üöÄ **Ready to merge!** All quality gates passed.' :
              '‚ö†Ô∏è **Fix failing tests before merging.**'
            }

            [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # EMERGENCY ROLLBACK (Manual Trigger Only)
  # ============================================================================

  rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rollback instructions
        run: |
          echo "=========================================="
          echo "‚èÆÔ∏è  MANUAL ROLLBACK PROCEDURE"
          echo "=========================================="
          echo ""
          echo "To rollback the deployment:"
          echo ""
          echo "1. Via Render Dashboard:"
          echo "   ‚Üí https://dashboard.render.com"
          echo "   ‚Üí Select your service"
          echo "   ‚Üí Click 'Rollback' button"
          echo ""
          echo "2. Via Git Revert:"
          echo "   ‚Üí git revert ${{ github.sha }}"
          echo "   ‚Üí git push origin main"
          echo ""
          echo "3. Via Git Reset (destructive):"
          echo "   ‚Üí git reset --hard HEAD~1"
          echo "   ‚Üí git push --force origin main"
          echo ""
          echo "=========================================="

      - name: Create rollback tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚èÆÔ∏è Production Rollback Initiated',
              body: `## Rollback Tracking

              A manual rollback was initiated for commit ${{ github.sha }}

              **Initiated by:** ${{ github.actor }}
              **Time:** ${new Date().toISOString()}

              **Next Steps:**
              1. Complete rollback via Render dashboard
              2. Verify production is stable
              3. Investigate what caused the rollback
              4. Create fix and re-deploy

              **Rollback Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `,
              labels: ['deployment', 'rollback', 'P0'],
              assignees: ['mattcarp']
            });
