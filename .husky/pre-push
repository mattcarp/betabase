#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-push hook - Run tests before pushing to remote
# This prevents broken code from reaching the remote repository

BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ” Pre-push checks for branch: $BRANCH"

# Only run full checks on main/develop branches
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
    echo "ğŸ“‹ Running critical tests before push to $BRANCH..."
    
    # Run critical tests (5 minutes)
    npm run test:local:critical
    
    if [ $? -ne 0 ]; then
        echo "âŒ Critical tests failed! Push aborted."
        echo "Fix the failing tests or use --no-verify to bypass (not recommended)"
        exit 1
    fi
    
    echo "âœ… All critical tests passed!"
else
    # For feature branches, just run smoke tests (2 minutes)
    echo "ğŸš€ Running smoke tests for feature branch..."
    npm run test:local:smoke
    
    if [ $? -ne 0 ]; then
        echo "âš ï¸  Smoke tests failed!"
        echo "Consider fixing before pushing, or use --no-verify to bypass"
        exit 1
    fi
fi

echo "âœ… Pre-push checks completed successfully!"